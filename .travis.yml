language: java
git:
  depth: false

addons:
  apt:
    packages:
      - docker-ce
services:
  - docker

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

jobs:
  include:
    - stage: assemble
      script: ./gradlew assemble -i
    - stage: unittest
      script:
        - ./gradlew test -i
        - if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then export SONAR_BRANCH="$TRAVIS_BRANCH"; else export SONAR_BRANCH="$TRAVIS_PULL_REQUEST_BRANCH"; fi;
          ./gradlew sonarqube -Dsonar.projectKey=xenit-eu_alfresco-docker-gradle-plugin -Dsonar.organization=xenit-eu -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$SONAR_TOKEN -Dsonar.branch.name=$SONAR_BRANCH
    - stage: deploy
      if: tag IS present AND env(TRAVIS_SECURE_ENV_VARS)
      script: ./gradlew publishPlugins -Pgradle.publish.key=$GRADLE_PUBLISH_KEY -Pgradle.publish.secret=$GRADLE_PUBLISH_SECRET

stages:
  - assemble
  - unittest
  - test
  - deploy

env:
  - GRADLE_INTEGRATION_TEST_VERSIONS=4.0,4.1,4.2
  - GRADLE_INTEGRATION_TEST_VERSIONS=4.3,4.4,4.5
  - GRADLE_INTEGRATION_TEST_VERSIONS=4.6,4.7,4.8
  - GRADLE_INTEGRATION_TEST_VERSIONS=4.9,4.10
  - GRADLE_INTEGRATION_TEST_VERSIONS=5.0,5.1

script:
  - ./gradlew integrationTest -i -PintegrationTestGradleVersions=$GRADLE_INTEGRATION_TEST_VERSIONS

